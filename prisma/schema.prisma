// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../lib/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USUÁRIOS E AUTENTICAÇÃO
// ============================================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String
  password          String?
  role              Role      @default(USER)

  // 2FA
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?

  // FP
  fpTotal           Int       @default(0)
  fpAvailable       Int       @default(0)
  currentStreak     Int       @default(0)
  longestStreak     Int       @default(0)
  lastActiveDate    DateTime?

  // FP (novo sistema)
  fp_balance     Int      @default(0)
  fp_lifetime    Int      @default(0)  // Total já ganho

  // Subscription
  subscription_tier     String   @default("free")  // 'free' | 'premium' | 'premium_plus'
  subscription_status   String   @default("inactive")  // 'active' | 'inactive' | 'cancelled' | 'trial'
  subscription_ends_at  DateTime?

  // Biometric quota
  free_baseline_used    Boolean  @default(false)  // Já usou baseline grátis?

  // Disciplina Progressiva (Game74)
  dp_score          Float     @default(0)    // Score DP acumulado (0-1000)
  dp_streak_days    Int       @default(0)    // Dias consecutivos >=70%
  dp_last_updated   DateTime?                // Ultima atualizacao DP

  // Flags de moderação
  isMuted           Boolean   @default(false)
  mutedUntil        DateTime?
  isBanned          Boolean   @default(false)
  bannedAt          DateTime?
  bannedReason      String?
  spamScore         Int       @default(0)

  // Relações
  posts             Post[]
  comments          Comment[]
  fpTransactions    FPTransaction[]
  badges            UserBadge[]
  moderationActions ModerationAction[]
  auditLogs         AuditLog[]
  videoAnalyses     VideoAnalysis[]
  biometricFPTransactions BiometricFPTransaction[]
  biometricBaselines BiometricBaseline[]
  biometricComparisons BiometricComparison[]
  arenaActivity     UserArenaActivity[]
  userExercises     UserExercise[]
  reavaliacoes      Reavaliacao[]
  disciplinaEntries DisciplinaProgressiva[]
  inactivityLogs    InactivityLog[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([role])
  @@index([fpTotal])
  @@index([isBanned])
  @@index([email])
}

enum Role {
  SUPER_ADMIN
  ADMIN
  FOUNDER
  MODERATOR
  USER
}

// ============================================
// ARENAS (COMUNIDADES)
// ============================================

model Arena {
  id                String    @id @default(cuid())
  slug              String    @unique
  name              String
  description       String    @db.Text
  icon              String
  color             String
  category          String
  hub_slug          String?   // Campo para agrupar arenas em hubs

  // Configurações
  isActive          Boolean   @default(true)
  isPaused          Boolean   @default(false)
  allowImages       Boolean   @default(true)
  allowLinks        Boolean   @default(true)
  allowVideos       Boolean   @default(false)

  // IA Settings
  aiPersona         AIPersona @default(BALANCED)
  aiInterventionRate Int      @default(50) // 0-100%
  aiFrustrationThreshold Int  @default(120) // minutos
  aiCooldown        Int       @default(5) // minutos entre respostas

  // NFV - Análise Biomecânica
  arenaType            ArenaType @default(GENERAL)
  parentArenaSlug      String?
  requiresFP           Int?
  requiresSubscription Boolean   @default(false)
  movementCategory     String?
  movementPattern      String?

  // Índice & Busca
  categoria         ArenaCategoria @default(COMUNIDADES_LIVRES)
  criadaPor         CreatedBy      @default(ADMIN)
  createdByUserId   String?

  // Métricas
  totalPosts        Int       @default(0)
  totalComments     Int       @default(0)
  dailyActiveUsers  Int       @default(0)
  status            ArenaStatus @default(COLD)

  // Relações
  posts             Post[]
  tags              ArenaTag[]
  founders          ArenaFounder[]
  videoAnalyses     VideoAnalysis[]
  userActivity      UserArenaActivity[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([slug])
  @@index([isActive])
  @@index([status])
  @@index([categoria])
}

enum AIPersona {
  SCIENTIFIC          // Citações diretas, formal
  MOTIVATIONAL        // Acolhedor, simples
  SUSTAINING          // Responde tudo, mantém conversa
  BALANCED            // Mix dos três
  BIOMECHANICS_EXPERT // Especialista em biomecânica
}

enum ArenaType {
  GENERAL      // Arena normal
  NFV_HUB      // Hub Biomecânico (Level 1)
  NFV_PREMIUM  // Arena Premium de Análise (Level 3)
}

enum AnalysisStatus {
  PENDING_AI
  AI_ANALYZED
  PENDING_REVIEW
  APPROVED
  REJECTED
  REVISION_NEEDED
}

enum ArenaStatus {
  HOT      // >10 posts/dia
  WARM     // 3-10 posts/dia
  COLD     // <3 posts/dia
  ARCHIVED // Desativada
}

enum ArenaCategoria {
  NUTRICAO_DIETAS           // Nutrição & Dietas
  TREINO_EXERCICIOS         // Treino & Exercícios
  BIOMECANICA_NFV           // Biomecânica & NFV
  AVALIACAO_BIOMECANICA_NFV // Avaliação Biomecânica (NFV) - Análise de Exercício
  AVALIACAO_BIOMETRICA_NFV  // Avaliação Biométrica (NFV) - Análise Corporal
  SAUDE_CONDICOES_CLINICAS  // Saúde & Condições Clínicas
  RECEITAS_ALIMENTACAO      // Receitas & Alimentação
  COMUNIDADES_LIVRES        // Comunidades Livres (debate)
}

enum CreatedBy {
  USER
  ADMIN
}

model ArenaTag {
  id      String @id @default(cuid())
  arenaId String
  tag     String

  arena   Arena  @relation(fields: [arenaId], references: [id], onDelete: Cascade)

  @@unique([arenaId, tag])
  @@index([arenaId])
}

model ArenaFounder {
  id        String @id @default(cuid())
  arenaId   String
  userId    String

  arena     Arena  @relation(fields: [arenaId], references: [id], onDelete: Cascade)

  @@unique([arenaId, userId])
  @@index([arenaId])
  @@index([userId])
}

// ============================================
// POSTS E COMENTÁRIOS
// ============================================

model Post {
  id              String    @id @default(cuid())
  arenaId         String
  userId          String
  content         String    @db.Text

  // Avatar (NUNCA gerado pelo LLM - atribuído pelo backend)
  avatarId        String?
  avatarImg       String?   // Path para imagem
  avatarInitialsColor String? // Cor das iniciais (fallback)

  // Status
  isPublished     Boolean   @default(true)
  isPinned        Boolean   @default(false)
  isOfficial      Boolean   @default(false) // Post da equipe
  isAIResponse    Boolean   @default(false)

  // Moderação
  isUnderReview   Boolean   @default(false)
  reviewedAt      DateTime?
  reviewedBy      String?
  isApproved      Boolean   @default(true)
  rejectionReason String?

  // Métricas
  viewCount       Int       @default(0)
  likeCount       Int       @default(0)
  commentCount    Int       @default(0)

  // Soft delete
  isDeleted       Boolean   @default(false)
  deletedAt       DateTime?

  // Relações
  arena           Arena     @relation(fields: [arenaId], references: [id])
  user            User      @relation(fields: [userId], references: [id])
  comments        Comment[]
  aiMetadata      AIMetadata?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([arenaId])
  @@index([userId])
  @@index([avatarId])
  @@index([isUnderReview])
  @@index([createdAt])
  @@index([isPublished])
}

model Comment {
  id              String    @id @default(cuid())
  postId          String
  userId          String
  content         String    @db.Text

  // Avatar (NUNCA gerado pelo LLM - atribuído pelo backend)
  avatarId        String?
  avatarImg       String?   // Path para imagem
  avatarInitialsColor String? // Cor das iniciais (fallback)

  // Status
  isAIResponse    Boolean   @default(false)

  // Moderação
  isUnderReview   Boolean   @default(false)
  isApproved      Boolean   @default(true)

  // Soft delete
  isDeleted       Boolean   @default(false)
  deletedAt       DateTime?

  // Relações
  post            Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([postId])
  @@index([userId])
  @@index([isUnderReview])
}

// ============================================
// METADADOS DA IA (RAG)
// ============================================

model AIMetadata {
  id              String   @id @default(cuid())
  postId          String   @unique

  // RAG Info
  chunksUsed      Json     // Array de chunks consultados
  booksReferenced Json     // Livros citados
  confidenceScore Float    // 0-1

  // Shadow Mode
  wasApproved     Boolean  @default(true)
  approvedBy      String?
  editedContent   String?  @db.Text

  // Relações
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([postId])
}

// ============================================
// SISTEMA DE FP
// ============================================

model FPTransaction {
  id          String   @id @default(cuid())
  userId      String
  amount      Int      // Pode ser negativo (punição)
  action      String   // "post_created", "helpful_comment", "spam_detected"
  description String

  // Metadata
  metadata    Json?    // Detalhes extras (post_id, etc)

  // Relações
  user        User     @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

model FPRule {
  id          String   @id @default(cuid())
  action      String   @unique // "post_created", "comment_helpful"
  fpValue     Int
  dailyCap    Int?     // Máximo de FP por essa ação/dia
  cooldown    Int?     // Minutos entre ações
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([action])
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeType String
  name      String
  icon      String
  earnedAt  DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([badgeType])
}

// ============================================
// MODERAÇÃO
// ============================================

model ModerationQueue {
  id              String   @id @default(cuid())
  postId          String?
  commentId       String?
  userId          String   // Autor do conteúdo

  // Detecção
  detectedBy      String   // "AI", "USER_REPORT", "MANUAL"
  reason          String   // "SPAM", "OFFENSIVE", "COMMERCIAL"
  flagScore       Int      // 0-100

  // Status
  status          ModerationStatus @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  decision        String?  // "APPROVE", "REJECT", "EDIT"

  createdAt       DateTime @default(now())

  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
  EDITED
}

model ModerationAction {
  id          String   @id @default(cuid())
  moderatorId String
  targetId    String   // User ID ou Post ID
  targetType  String   // "USER", "POST", "COMMENT"
  action      String   // "MUTE", "BAN", "DELETE", "APPROVE"
  reason      String
  duration    Int?     // Em minutos (para mute/ban temporário)

  moderator   User     @relation(fields: [moderatorId], references: [id])

  createdAt   DateTime @default(now())

  @@index([moderatorId])
  @@index([createdAt])
  @@index([targetType, targetId])
}

model SpamFilter {
  id          String   @id @default(cuid())
  type        String   // "KEYWORD", "LINK", "PATTERN"
  value       String
  isActive    Boolean  @default(true)
  severity    Int      // 1-10

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([isActive])
}

// ============================================
// AUDITORIA (LOGS IMUTÁVEIS)
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String   // Quem fez a ação
  action      String   // "UPDATE_ARENA", "BAN_USER", "CHANGE_FP"
  targetType  String   // "ARENA", "USER", "POST"
  targetId    String

  // Dados da ação
  before      Json?    // Estado anterior
  after       Json?    // Estado novo

  // Metadata
  ipAddress   String?
  userAgent   String?

  // Relações
  user        User     @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@index([action])
}

// ============================================
// NFV - ANÁLISE BIOMECÂNICA (VIDEO)
// Consolidated model - merges Arena NFV + Queue system
// ============================================

model VideoAnalysis {
  id                     String          @id @default(cuid())
  videoId                String          @unique

  // Relações
  arenaId                String?         // Opcional - pode ser análise standalone
  userId                 String

  // Video
  videoUrl               String
  videoPath              String
  thumbnailUrl           String?
  durationSeconds        Int?

  // Movimento/Exercício
  exerciseName           String          // Nome do exercício (ex: "Agachamento Livre")
  movementPattern        String?         // Padrão de movimento (ex: "squat", "hinge")
  captureMode            String          // 'ESSENTIAL' | 'ADVANCED' | 'PRO'
  userDescription        String?         @db.Text

  // Gating/Monetização
  fpCost                 Int             @default(0)
  paidWithSubscription   Boolean         @default(false)

  // Pipeline de Processamento
  status                 String          @default("queued")  // 'queued' | 'processing' | 'completed' | 'failed'
  progress               Int             @default(0)
  currentStage           String?         // 'extraction' | 'detection' | 'analysis'

  // Job Queue
  jobId                  String?         @unique
  queuedAt               DateTime        @default(now())
  startedAt              DateTime?
  completedAt            DateTime?
  failedAt               DateTime?
  errorMessage           String?

  // IA Pré-Análise (Shadow Mode)
  aiAnalysis             Json?
  aiAnalyzedAt           DateTime?
  aiConfidence           Float?
  aiStatus               AnalysisStatus  @default(PENDING_AI)

  // Revisão Admin
  adminReviewerId        String?
  adminNotes             String?         @db.Text
  adminEditedAnalysis    Json?
  reviewedAt             DateTime?

  // Publicado
  publishedAnalysis      Json?
  publishedAt            DateTime?
  rejectionReason        String?

  // Webhook
  webhookUrl             String?
  webhookSentAt          DateTime?

  // Métricas
  viewCount              Int             @default(0)
  helpfulVotes           Int             @default(0)

  // Metadata
  metadata               Json?

  // Relações
  arena                  Arena?          @relation(fields: [arenaId], references: [id])
  user                   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  result                 BiomechanicalResult?
  tags                   VideoAnalysisTag[]
  baselineComparisons    AnalysisComparison[] @relation("BaselineComparison")
  currentComparisons     AnalysisComparison[] @relation("CurrentComparison")

  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  @@index([arenaId])
  @@index([userId, status])
  @@index([videoId])
  @@index([jobId])
  @@index([aiStatus])
  @@index([movementPattern])
  @@index([createdAt])
  @@map("video_analyses")
}

// ============================================
// ANALYTICS
// ============================================

model DailyMetrics {
  id              String   @id @default(cuid())
  date            DateTime @unique @db.Date

  // Usuários
  dau             Int      @default(0)
  newUsers        Int      @default(0)
  activeUsers     Int      @default(0)

  // Conteúdo
  postsCreated    Int      @default(0)
  commentsCreated Int      @default(0)

  // IA
  aiResponses     Int      @default(0)
  aiApprovalRate  Float    @default(0)

  // FP
  fpIssued        Int      @default(0)
  fpConsumed      Int      @default(0)

  // Moderação
  spamDetected    Int      @default(0)
  contentRemoved  Int      @default(0)

  createdAt       DateTime @default(now())

  @@index([date])
}

// ============================================
// JUIZ BIOMÉTRICO - AVALIAÇÃO VISUAL
// ============================================

model BiometricBaseline {
  id                String   @id @default(cuid())
  user_id           String
  user              User     @relation(fields: [user_id], references: [id])

  // Análise técnica completa
  analysis_text     String   @db.Text

  // Metadados das imagens (URLs ou paths)
  images_metadata   Json     // { frontal, lateral, posterior }

  // Contexto do protocolo no momento da avaliação
  protocol_context  String?  @db.Text

  // Monetization
  was_free          Boolean  @default(false)  // True se foi a baseline grátis
  cost_fps          Int      @default(0)      // Quanto custou (0 se grátis)

  // Relações
  comparisons       BiometricComparison[]

  created_at        DateTime @default(now())

  @@index([user_id])
  @@index([created_at])
  @@map("biometric_baselines")
}

model BiometricComparison {
  id                String            @id @default(cuid())
  baseline_id       String
  baseline          BiometricBaseline @relation(fields: [baseline_id], references: [id], onDelete: Cascade)
  user_id           String
  user              User              @relation(fields: [user_id], references: [id])

  // Análise comparativa técnica
  analysis_text     String            @db.Text

  // Metadados das novas imagens
  images_metadata   Json              // { frontal, lateral, posterior }

  // Contexto do protocolo na reavaliação
  protocol_context  String?           @db.Text

  // Monetization
  cost_fps          Int               // Quanto custou (25 FPs ou 0 se Premium)
  payment_method    String            // 'fp' | 'subscription'
  transaction_id    String?           // Referência para FPTransaction

  created_at        DateTime          @default(now())

  @@index([baseline_id])
  @@index([user_id])
  @@index([created_at])
  @@map("biometric_comparisons")
}

// ============================================
// FP - SISTEMA DE MONETIZAÇÃO
// ============================================

model BiometricFPTransaction {
  id                String   @id @default(cuid())
  user_id           String
  user              User     @relation(fields: [user_id], references: [id])

  amount            Int      // Positivo = ganho, Negativo = gasto
  balance_after     Int      // Saldo após transação

  transaction_type  String   // 'purchase' | 'spend' | 'reward' | 'refund' | 'bonus'
  category          String   // 'biometric_analysis' | 'meal_plan' | 'workout' | etc

  // Metadata
  description       String
  reference_id      String?  // ID do item comprado (ex: comparison_id)
  metadata          Json?    // Dados adicionais

  created_at        DateTime @default(now())

  @@index([user_id])
  @@index([transaction_type])
  @@index([created_at])
  @@map("fp_transactions")
}

model BiometricPricing {
  id                String   @id @default(cuid())

  item_type         String   @unique  // 'baseline' | 'comparison' | 'export_pdf'

  // Preços
  fps_cost          Int      // Custo em FP
  premium_free      Boolean  @default(false)  // Grátis para Premium?

  // Regras especiais
  first_free        Boolean  @default(false)  // Primeira vez grátis?
  max_per_month     Int?     // Limite mensal (null = ilimitado)

  // Active
  is_active         Boolean  @default(true)

  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  @@map("biometric_pricing")
}

// ============================================
// TRACKING DE ATIVIDADE DE USUÁRIOS EM ARENAS
// Updated: 2026-02-06 - Force rebuild
// ============================================

model UserArenaActivity {
  id          String   @id @default(cuid())
  userId      String
  arenaId     String
  lastSeenAt  DateTime @default(now())
  visitCount  Int      @default(1)

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  arena       Arena    @relation(fields: [arenaId], references: [id], onDelete: Cascade)

  @@unique([userId, arenaId])
  @@index([arenaId, lastSeenAt])
  @@index([userId])
  @@map("user_arena_activity")
}

// ============================================
// Visitantes anônimos (presença sem login)
// ============================================

model AnonymousVisitor {
  visitorId  String   @id
  lastSeenAt DateTime @default(now())

  @@index([lastSeenAt])
}

// ============================================
// RESULTADOS BIOMECÂNICOS
// ============================================

model BiomechanicalResult {
  id                String   @id @default(cuid())
  videoAnalysisId   String   @unique

  // Scores principais
  motorScore        Float
  stabilizerScore   Float
  symmetryScore     Float
  compensationScore Float
  igpbScore         Float

  // Confiabilidade
  confidenceScore   Float
  confidenceLevel   String   // 'baixa' | 'moderada' | 'alta' | 'muito_alta'
  riskLevel         String   // 'LOW' | 'MODERATE' | 'HIGH' | 'CRITICAL'

  // Análise detalhada (JSON)
  fullAnalysis      Json

  // Processamento
  totalFrames       Int
  processedFrames   Int
  successRate       Float
  processingTimeMs  Int
  fps               Float

  // Relação
  videoAnalysis     VideoAnalysis @relation(fields: [videoAnalysisId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([videoAnalysisId])
  @@map("biomechanical_results")
}

// ============================================
// CATÁLOGO DE EXERCÍCIOS
// ============================================

model Exercise {
  id                String   @id @default(cuid())
  name              String   @unique
  slug              String   @unique
  category          ExerciseCategory
  movementPattern   String   // 'squat', 'hinge', 'push', 'pull', etc

  // Descrição
  description       String?  @db.Text
  instructions      String?  @db.Text
  thumbnailUrl      String?

  // Biomecânica
  primaryMuscles    String[] // ['quadriceps', 'glutes', ...]
  secondaryMuscles  String[] // ['hamstrings', 'calves', ...]
  equipment         String[] // ['barbell', 'dumbbells', ...]

  // MediaPipe Landmarks esperados
  requiredLandmarks Json?    // Lista de landmarks necessários para análise

  // Template de análise
  analysisTemplate  Json?    // Template específico para esse exercício

  // Status
  isActive          Boolean  @default(true)
  isPremium         Boolean  @default(false)

  // Relações
  userExercises     UserExercise[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([category])
  @@index([movementPattern])
  @@index([isActive])
  @@map("exercises")
}

enum ExerciseCategory {
  LOWER_BODY        // Membros inferiores
  UPPER_BODY_PUSH   // Empurrão superior
  UPPER_BODY_PULL   // Puxada superior
  CORE              // Core/abdômen
  FULL_BODY         // Corpo todo
  MOBILITY          // Mobilidade
  CARDIO            // Cardiovascular
}

// ============================================
// HISTÓRICO DE EXERCÍCIOS DO USUÁRIO
// ============================================

model UserExercise {
  id                String   @id @default(cuid())
  userId            String
  exerciseId        String

  // Execução
  performedAt       DateTime @default(now())
  sets              Int?
  reps              Int?
  weight            Float?   // kg
  notes             String?  @db.Text

  // Relação com análise
  videoAnalysisId   String?  @unique

  // Relações
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise          Exercise @relation(fields: [exerciseId], references: [id])

  createdAt         DateTime @default(now())

  @@index([userId, performedAt])
  @@index([exerciseId])
  @@map("user_exercises")
}

// ============================================
// PLANOS CORRETIVOS
// ============================================

model CorrectivePlan {
  id                String   @id @default(cuid())
  userId            String
  videoAnalysisId   String

  // Plano
  title             String
  description       String   @db.Text
  goals             String[] // Objetivos do plano
  duration          Int      // Duração em semanas

  // Protocolo
  protocol          Json     // Exercícios, séries, reps, progressão

  // Status
  status            PlanStatus @default(ACTIVE)
  startedAt         DateTime?
  completedAt       DateTime?
  cancelledAt       DateTime?

  // Relações
  sessions          CorrectiveSession[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId, status])
  @@index([videoAnalysisId])
  @@map("corrective_plans")
}

enum PlanStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  PAUSED
}

// ============================================
// SESSÕES DE EXECUÇÃO DO PLANO
// ============================================

model CorrectiveSession {
  id                String   @id @default(cuid())
  planId            String
  userId            String

  // Sessão
  sessionNumber     Int      // 1, 2, 3...
  scheduledFor      DateTime?
  performedAt       DateTime?

  // Execução
  exercisesCompleted Json?   // Lista de exercícios realizados
  notes             String?  @db.Text
  userFeedback      String?  // 'easy' | 'moderate' | 'hard'
  painLevel         Int?     // 0-10

  // Status
  status            SessionStatus @default(PENDING)

  // Relação
  plan              CorrectivePlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([planId, sessionNumber])
  @@index([userId, performedAt])
  @@map("corrective_sessions")
}

enum SessionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

// ============================================
// COMPARAÇÃO ENTRE ANÁLISES
// ============================================

model AnalysisComparison {
  id                String   @id @default(cuid())
  userId            String
  baselineId        String   // ID da análise de referência
  comparisonId      String   // ID da análise atual

  // Diferenças calculadas
  motorDelta        Float
  stabilizerDelta   Float
  symmetryDelta     Float
  igpbDelta         Float

  // Evolução
  improvementPercent Float
  regressionPercent  Float

  // Análise textual
  summary           String   @db.Text
  recommendations   String?  @db.Text

  // Relações
  baseline          VideoAnalysis @relation("BaselineComparison", fields: [baselineId], references: [id])
  comparison        VideoAnalysis @relation("CurrentComparison", fields: [comparisonId], references: [id])

  createdAt         DateTime @default(now())

  @@index([userId, createdAt])
  @@index([baselineId])
  @@index([comparisonId])
  @@map("analysis_comparisons")
}

// ============================================
// TAGS PARA ANÁLISES
// ============================================

model VideoAnalysisTag {
  id                String   @id @default(cuid())
  videoAnalysisId   String
  tag               String

  // Relação
  videoAnalysis     VideoAnalysis @relation(fields: [videoAnalysisId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())

  @@unique([videoAnalysisId, tag])
  @@index([tag])
  @@map("video_analysis_tags")
}

// ============================================
// API KEYS (para integrações externas)
// ============================================

model ApiKey {
  id                String   @id @default(cuid())
  userId            String
  name              String
  key               String   @unique
  hashedKey         String   @unique

  // Permissões
  permissions       String[] // ['read:analyses', 'write:analyses', etc]
  rateLimit         Int      @default(100) // Requests por hora

  // Status
  isActive          Boolean  @default(true)
  lastUsedAt        DateTime?
  expiresAt         DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([key])
  @@map("api_keys")
}

// ============================================
// WEBHOOKS
// ============================================

model Webhook {
  id                String   @id @default(cuid())
  userId            String
  url               String
  secret            String?  // Para validação HMAC

  // Eventos
  events            String[] // ['analysis.completed', 'analysis.failed', etc]

  // Status
  isActive          Boolean  @default(true)
  failureCount      Int      @default(0)
  lastFailedAt      DateTime?

  // Relações
  deliveries        WebhookDelivery[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
  @@map("webhooks")
}

// ============================================
// ENTREGAS DE WEBHOOK
// ============================================

model WebhookDelivery {
  id                String   @id @default(cuid())
  webhookId         String
  event             String   // 'analysis.completed'
  payload           Json

  // Delivery
  status            DeliveryStatus @default(PENDING)
  httpStatus        Int?
  responseBody      String?  @db.Text
  attempts          Int      @default(0)
  maxAttempts       Int      @default(3)

  // Timing
  sentAt            DateTime?
  deliveredAt       DateTime?
  failedAt          DateTime?
  nextRetryAt       DateTime?

  // Error
  errorMessage      String?

  // Relação
  webhook           Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([webhookId, status])
  @@index([status, nextRetryAt])
  @@map("webhook_deliveries")
}

enum DeliveryStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  RETRYING
}

// ============================================
// REAVALIACAO PREMIUM (Game73)
// ============================================

model Reavaliacao {
  id              String   @id @default(cuid())
  userId          String
  fpCost          Int      @default(120)
  status          String   @default("completed")  // 'completed' | 'cancelled' | 'refunded'
  transactionId   String?  // Referencia para FPTransaction

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@map("reavaliacoes")
}

// ============================================
// DISCIPLINA PROGRESSIVA (Game74)
// ============================================

model DisciplinaProgressiva {
  id                String   @id @default(cuid())
  userId            String
  date              DateTime @db.Date
  mealsCompleted    Int      @default(0)
  mealsTarget       Int      @default(6)
  trainingDone      Boolean  @default(false)
  hydrationMet      Boolean  @default(false)
  sleepMet          Boolean  @default(false)
  emotionalCheckin  Boolean  @default(false)
  dailyScore        Float    @default(0)  // 0-100

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("disciplina_progressiva")
}

// ============================================
// PENALIDADE INATIVIDADE (Game75)
// ============================================

model InactivityLog {
  id              String   @id @default(cuid())
  userId          String
  daysInactive    Int
  penaltyFP       Int      @default(0)
  tier            String    // 'warning' | 'light' | 'moderate' | 'severe' | 'maximum'
  warningSent     Boolean  @default(false)
  penaltyApplied  Boolean  @default(false)

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("inactivity_logs")
}
